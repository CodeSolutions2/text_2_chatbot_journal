<!DOCTYPE html>
<html>
<head></head>
<body>    

<h1>Text-to-chatbot webapp</h1>
<ol type="A">
	<li>Input GitHub repository url to file</li>
	<li></li>
	<li></li>
	<li></li>
</ol>

<!-- ---------------------------------------- -->
<!-- View two split window -->
<div align="left">
<table style='text-align: left; width: 500px; display:block'>
<tr>

<th id="inputs">
<h1></h1>

<h3>[Step 0] Input GitHub repository url to file to include in the analysis (ie: https://github.com/CodeSolutions2/text_2_chatbot_journal/main/journal_data.txt).</h3>
<input id="file_download_url" type="text" value="" placeholder="file_download_url" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<input id="prompt" type="text" value="" placeholder="prompt" rows="10" cols="100" style="display:none; text-align: left; width: 600px;">

<h3>[Step 2] Select method type to create a chatbot</h3>

OpenAI Assistant
  Q&A finetuning
  Q&A finetuning and Vector Similarity
  
  Run OpenAI Assistant OR Q&A finetuning
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">


<br>
<h3>[Step 3] View notifications and errors</h3>
<div id="notification"></div>
<div id="error"></div>
<br>
<h3>[Step 4] View Selected text</h3>
<textarea id="selected_text" rows="35" cols="100" placeholder="Selected Text" style="display:block" width:100px; height: 200px;></textarea>
</th>

<!-- ---------------------------------------- -->

<th id="outputs">
<h3>[Step 5] Chatbot Area</h3>
<!-- ---------------------------------------- -->
<!-- View chatbot -->
<input id="prompt_input" type="text" value="" placeholder="Ask the chatbot a question about the text" rows="10" cols="100" style="display:block; text-align: left;  height: 50px; width:300px;"><button id="use_chatbot" onclick="use_chatbot()">[Step 4] Ask chatbot</button>
<table id="chatbot_output" style='text-align: left; width: 300px; display:block'>
<!-- dynamically add rows here -->
</table>
<!-- ---------------------------------------- -->
</th>
	
</tr>
</table>
</div>  
<!-- ---------------------------------------- -->


<!-- ---------------------------------------- -->
<!-- CSS -->
<style>
div { padding: 10px; display:block; font-family:courier; font-size:15px; height:300px; }
	
div#notification { position: relative; color: #3236a8; }
div#error { position: relative; color: #bd1f17; }

table {vertical-align: top; border-collapse: collapse; position: relative; z-index: 0; border: 0px solid black;}

tr {vertical-align: top; border: 0px solid black; padding: 10px 10px; }

th, td {vertical-align: top; border: 0px solid black; padding: 10px; }
th#pdf_viewer_input {width: 100%; }
th#pdf_viewer_output {width: 100%; }
</style>

	  
<!-- --------------------------------------------------- -->	  

	  
<script>


var month = {"01": "january", "02": "february", "03": "march", "04": "april", "05": "may", "06": "june", "07": "july", "08": "august", "09": "september", "10": "october", "11": "november", "12": "december"};






// ----------------------------------------------------
// Step 2 : dropdown A
// ----------------------------------------------------
async function run_OpenAI_assistant() {

	
	// Step A: outputs FILE_ID
	await upload_files()
		// Step B: outputs ASSISTANT_ID
		.then(async function() { await create_an_assistant(); })
		// Step C: outputs THREAD_ID
		.then(async function() { await create_a_thread(); })
		// Step D: outputs THREAD_MESSAGE_ID
		.then(async function() { await add_a_message_to_a_thread(); })
		// Step E: outputs RUN_ID
		.then(async function() {  await run_the_assistant(); })
		// Step F: wait for run to finish
		.then(async function() { await wait_for_run_to_finish(); })
		// Step G
		.then(async function() { await display_the_assistants_response(); })
		.catch(error => { document.getElementById('error').innerHTML = error; });
}

// ----------------------------------------------------
// Step 2 : dropdown B (run_QandA_finetuning)
// ----------------------------------------------------
async function run_QandA_finetuning() {

  // Read in text data, Display text data in textarea
  await GET_text_from_file_wo_auth_GitHub_RESTAPI()
  // Sort text by timestamp
    .then(async function() {  await sort_text_by_timestamp(transcribed_text) })
  //

	
		.then(async function(text_by_date) { 
			// Processing information
			outp.innerHTML = 'Processing transcribed text';
			// readaudio values are delayed becuse of processing with OpenAI endpoint
			// ----------------------------------------------------
			// Obtain output
			// ----------------------------------------------------
			// [ ***** For debugging Step 3 : do not call model everytime ***** ]
			// return await create_Q_and_As_from_text(text_by_date); 
			// OR
			// Save on using the model: to test other part of the workflow
			return await step1_text_output();
			// ----------------------------------------------------
		})
		.catch(error => { document.getElementById('error').innerHTML = error; });
}



// ----------------------------------------------------
// Step 2 : dropdown C
// ----------------------------------------------------
async function run_QandA_finetuning_vector_sim() {

	
		.catch(error => { document.getElementById('error').innerHTML = error; });
}


  
// ----------------------------------------------------
// SUBFUNCTIONS: Step 2 : dropdown B (run_QandA_finetuning)
// ----------------------------------------------------
async function GET_text_from_file_wo_auth_GitHub_RESTAPI() {
	
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	var file_objects = [];
	
	return await fetch(url)
		.then(res => res.json())
		.then(data => { 
			data.forEach(async function(file) {
				var regexp = new RegExp(`${journal_filename}`, 'g');
				if (file.type === 'file' && file.name.match(regexp)) {
					file_objects.push(file);
				}
			});
			return file_objects;
		})
		.then(async function (file_objects) {
			var file_object = file_objects.at(0);
		   
			var file_download_url = file_object.download_url;
			// console.log("file_download_url:", file_download_url);
		   
			sha_val = file_object.sha;
			// console.log("sha_val:", sha_val);

			return file_download_url;
		})
		.then(async function (file_download_url) {
			// Way 1: to get text from file
			var text_out = await fetch(file_download_url); return text_out
		})
		.then(response => response.text())
		.then(async function(text_out) { 
			document.getElementById("journal").innerHTML = text_out;  // print existing journal in text area
			return text_out;
		})
		.catch(error => { console.log(error); });
}


async function sort_text_by_timestamp(transcribed_text) {
	// Sorting
	const regexp = /[0-9{4}]+_[0-9{2}]+_[0-9{2}]+_[0-9{2}]+_[0-9{2}]+_[0-9{2}]+\n/g; // pattern to look for
	let matches = [...transcribed_text.matchAll(regexp)];
	// console.log('matches: ', matches);
	
	let text_st = 0;
	let text_end = 0;
	let text_by_date = [];
	
	// next: get array of start and end values to cut string
	matches.forEach(async function(row, index) {
		let date = row.at(0);
		// console.log('date: ', date);
		text_st = date.length + text_end;
			
		if (matches.length > (index+1)){
			text_end = matches[index+1].index - 1;
		} else {
			text_end = transcribed_text.length;
		}
		// console.log('text_st: ', text_st, 'text_end: ', text_end);
		text_by_date.push({date: date, text: transcribed_text.slice(text_st, text_end)});
	});
	
	console.log('text_by_date: ', text_by_date);

	// -----------------------------------
	
	// Optional: could sort the Array of dictionaries by date, so it is in chronological order
	
	// -----------------------------------
	
	return text_by_date;
}

	
</script>

  </body>
</html>
